<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìš°ë¦¬ì‚¬ì£¼ ê°„ì´ê³„ì‚°ê¸° Beta</title>
  <meta name="description" content="ìš°ë¦¬ì‚¬ì£¼ì¡°í•© ì¸ì¶œ ì‹œ ê·¼ë¡œì†Œë“ ê³¼ì„¸ì•¡ì„ ì—¬ëŸ¬ ì·¨ë“ ë¡œíŠ¸ë¥¼ í•œ ë²ˆì— ê³„ì‚°í•©ë‹ˆë‹¤." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input.num { text-align:right; font-variant-numeric: tabular-nums; }
    input.num::placeholder { color:#9ca3af; }
    input[disabled] { background-color:#ecfdf5 !important; color:#6b7280 !important; cursor:not-allowed; }
    body { font-family: 'Pretendard','Apple SD Gothic Neo',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans',sans-serif; }
    .cute-focus { outline: none; }
    .cute-focus:focus { box-shadow: 0 0 0 3px rgba(16,185,129,0.25); border-color:#34d399; }
    .mint-card { border-radius: 1.25rem; border:1px solid #a7f3d0; background: rgba(255,255,255,0.92); box-shadow: 0 8px 20px rgba(16,185,129,0.08); }
    .mint-btn { border-radius: 9999px; padding: .35rem .7rem; font-size: 0.75rem; font-weight: 600; transition: .15s ease; }
    .mint-btn-ghost { background:white; border:1px solid #a7f3d0; color:#065f46; }
    .sec-title { color:#047857; }
    .tbl th, .tbl td { border-bottom:1px solid #d1fae5; }
    .icon-btn { border: 1px solid #a7f3d0; border-radius: .65rem; padding: .25rem .5rem; }
  </style>
</head>

<body class="bg-emerald-50 text-gray-900">
  <header class="sticky top-0 z-10 bg-gradient-to-r from-emerald-200 to-emerald-100 backdrop-blur border-b border-emerald-300 shadow-sm">
    <div class="mx-auto max-w-6xl px-5 py-3 flex items-center justify-between">
      <h1 class="text-lg font-extrabold text-emerald-800 tracking-tight">ìš°ë¦¬ì‚¬ì£¼ ê°„ì´ê³„ì‚°ê¸° <span class=\"text-xs text-emerald-700 align-top\">Beta</span><span class="text-xs text-emerald-700 align-top">ë©€í‹°-ë¡œíŠ¸</span>
      </h1>
      <a href="#how" class="text-sm text-emerald-800 hover:text-emerald-900 transition">ë¡œì§/ì£¼ì˜ì‚¬í•­ ğŸ’¡</a>
    </div>
    <div class="mx-auto max-w-6xl px-5 pb-3">
      <div class="rounded-2xl border border-emerald-300 bg-emerald-100/70 text-emerald-900 text-xs p-3 leading-5 shadow-sm">
        <span class="font-semibold">ğŸ“‹ ì¤€ë¹„ë¬¼:</span>
        ì§ì „ì—°ë„ ê·¼ë¡œì†Œë“ì›ì²œì§•ìˆ˜ì˜ìˆ˜ì¦, (ìˆë‹¤ë©´) 5ì›” ì¢…í•©ì†Œë“ì„¸ ì‹ ê³ ë‚´ì—­, <span>ê° ë¡œíŠ¸ë³„ ì·¨ë“ì¼ìÂ·ì·¨ë“ë‹¨ê°€Â·ì¸ì¶œì£¼ì‹ìˆ˜, ì¸ì¶œì¼ì ë° ì¸ì¶œì‹œê°€</span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-5 py-6 space-y-6">
    <!-- TOP: ì¸ì¶œ ë¡œíŠ¸ ì…ë ¥ (full width) -->
    <section class="mint-card p-5">
      <div class="flex items-center justify-between">
        <h2 class="mb-3 text-lg font-semibold sec-title">ì¸ì¶œ ë¡œíŠ¸ ì…ë ¥ (ì—¬ëŸ¬ í–‰ ì¶”ê°€ ê°€ëŠ¥) ğŸ“‹</h2>
        <div class="flex gap-2">
          <button id="addRow" class="mint-btn mint-btn-ghost">+ í–‰ ì¶”ê°€</button>
          <button id="clearRows" class="mint-btn mint-btn-ghost">ğŸ§¹ í–‰ ëª¨ë‘ ì‚­ì œ</button>
        </div>
      </div>
      <div class="overflow-auto">
        <table class="w-full text-sm tbl">
          <thead class="text-emerald-800">
            <tr>
              <th class="text-left px-2 py-2">#</th>
              <th class="text-left px-2 py-2">ì·¨ë“ì¼ì</th>
              <th class="text-right px-2 py-2">ì·¨ë“ë‹¨ê°€(ì›/ì£¼)</th>
              <th class="text-right px-2 py-2">ì¸ì¶œì£¼ì‹ìˆ˜(ì£¼)</th>
              <th class="text-right px-2 py-2">ë³´ìœ ê¸°ê°„(ì˜ë¬´ì˜ˆíƒ ì œì™¸)</th>
              <th class="text-right px-2 py-2">ì ìš© ë¹„ê³¼ì„¸ìœ¨</th>
              <th class="text-right px-2 py-2">ê³¼ì„¸ë‹¨ê°€</th>
              <th class="text-right px-2 py-2">ê³¼ì„¸ ê¸ˆì•¡</th>
              <th class="text-center px-2 py-2">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="lotBody"></tbody>
        </table>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3">
        <label class="grid grid-cols-1 gap-1">
          <span class="text-sm text-gray-700">ì˜ë¬´ì˜ˆíƒê¸°ê°„(ê³µí†µ)</span>
          <div class="flex items-center gap-2">
            <input id="escrowYears" type="text" class="num w-24 rounded-xl border border-emerald-300 px-3 py-2 cute-focus" value="1" />
            <span class="text-xs text-gray-500">ë…„</span>
          </div>
        </label>
        <label class="grid grid-cols-1 gap-1">
          <span class="text-sm text-gray-700">ì¸ì¶œì¼ì(ê³µí†µ)</span>
          <input id="wdDate" type="date" class="w-full sm:w-40 rounded-xl border border-emerald-300 px-3 py-2 cute-focus" />
        </label>
        <label class="grid grid-cols-1 gap-1">
          <span class="text-sm text-gray-700">ì¸ì¶œì¼ì ì‹œê°€(ê³µí†µ)</span>
          <div class="flex items-center gap-2">
            <input id="fmvAtWithdraw" type="text" class="num w-40 rounded-xl border border-emerald-300 px-3 py-2 cute-focus" placeholder="0" value="0" />
            <span class="text-xs text-gray-500">ì›/ì£¼</span>
          </div>
        </label>
      </div>
      <p class="text-xs text-emerald-700 mt-2">â€» ê° í–‰ì€ â€œê°™ì€ ì·¨ë“ì¼Â·ë‹¨ê°€ì—ì„œ ì¸ì¶œí•˜ëŠ” ì£¼ì‹ìˆ˜â€ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
    </section>

    <!-- MIDDLE: 2-column inputs -->
    <section class="grid grid-cols-1 gap-6 md:grid-cols-2">
      <!-- ê¸‰ì—¬ ì •ë³´ -->
      <div class="space-y-6">
        <div class="mint-card p-5">
          <h2 class="mb-3 text-lg font-semibold sec-title">ê¸‰ì—¬ ì •ë³´ ğŸ§¾</h2>
          <div class="space-y-2">
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700 whitespace-nowrap">ì§ì „ì—°ë„ ì´ê¸‰ì—¬ì•¡ (ì›) <span class="text-xs text-gray-500 whitespace-nowrap">(4ëŒ€ë³´í—˜ ê·¼ì‚¬)</span></span>
              <input id="prevYearSalary" type="text" class="num w-56 rounded-xl border border-emerald-300 px-3 py-2 cute-focus" placeholder="0" value="0" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">ì˜¬í•´ ì˜ˆìƒ ì´ê¸‰ì—¬ì•¡ (ì›) <span class="text-xs text-gray-500">(ì„¸ìœ¨ ì‹œë®¬ë ˆì´ì…˜ìš©)</span></span>
              <input id="currYearSalary" type="text" class="num w-56 rounded-xl border border-emerald-300 px-3 py-2 cute-focus" placeholder="0" value="0" />
            </label>
            <label class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm text-gray-700">ê·¼ë¡œì†Œë“ ì™¸ ì¢…í•©ì†Œë“ê¸ˆì•¡ (ì›)</div>
                <div class="text-xs text-gray-500 mt-0.5">(ì´ìÂ·ë°°ë‹¹Â·ì‚¬ì—…Â·ê¸°íƒ€ ë“±)</div>
              </div>
              <input id="otherIncome" type="text" class="num w-56 rounded-xl border border-emerald-300 px-3 py-2 cute-focus" placeholder="0" value="0" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-sm text-gray-700">ì¤‘ì†Œê¸°ì—… ì—¬ë¶€ ğŸŒ±</span>
              <input id="isSME" type="checkbox" class="h-5 w-5 accent-emerald-500" />
            </label>
            <p class="text-xs text-emerald-700 leading-5">â€» ì´ê¸‰ì—¬ì•¡ì€ ê¸‰ì—¬ëª…ì„¸ì„œì˜ <strong>ì´ì§€ê¸‰ì•¡</strong>(ì„±ê³¼ê¸‰ í¬í•¨) ê¸°ì¤€ ê·¼ì‚¬ì¹˜ì˜ˆìš”.</p>
          </div>
        </div>

        <!-- ê³µì œ(ê·¼ì‚¬) ì„¤ì • + ì•¡ì…˜ -->
        <div class="mint-card p-5">
          <div class="flex items-center justify-between">
            <h2 class="mb-3 text-lg font-semibold sec-title">ê³µì œ(ê·¼ì‚¬) ì„¤ì • ğŸ§®</h2>
            <button id="toggleSI" class="mint-btn mint-btn-ghost text-xs whitespace-nowrap">4ëŒ€ë³´í—˜ìœ¨ í¸ì§‘</button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">ê¸°ë³¸ê³µì œ ì¸ì›(ë³¸ì¸ í¬í•¨)</span>
              <input id="basicDeductCount" type="text" class="num w-32 rounded-xl border border-emerald-300 px-3 py-2 cute-focus" value="1" />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">êµ­ë¯¼ì—°ê¸ˆìœ¨(ê·¼ë¡œìë¶€ë‹´, %)</span>
              <input id="rateNP" type="text" class="num w-32 rounded-xl border border-emerald-300 px-3 py-2" value="4.5" disabled />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">ê±´ê°•ë³´í—˜ìœ¨(ê·¼ë¡œìë¶€ë‹´, %)</span>
              <input id="rateHI" type="text" class="num w-32 rounded-xl border border-emerald-300 px-3 py-2" value="3.545" disabled />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">ì¥ê¸°ìš”ì–‘(ê±´ë³´ì˜ %, ê·¼ë¡œìë¶€ë‹´)</span>
              <input id="rateLTC" type="text" class="num w-32 rounded-xl border border-emerald-300 px-3 py-2" value="12.95" disabled />
            </label>
            <label class="flex items-center justify-between gap-3">
              <span class="text-gray-700">ê³ ìš©ë³´í—˜ìœ¨(ê·¼ë¡œìë¶€ë‹´, %)</span>
              <input id="rateEI" type="text" class="num w-32 rounded-xl border border-emerald-300 px-3 py-2" value="0.9" disabled />
            </label>

            <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-2 items-end">
              <div class="flex items-center justify-between gap-3">
                <span class="text-gray-700">ìš°ë¦¬ì‚¬ì£¼ì¡°í•© ì¶œì—° ì†Œë“ê³µì œ (ì›)</span>
                <input id="esopDeduct" type="text" class="num w-40 rounded-xl border border-emerald-300 px-3 py-2" value="0" />
              </div>
              <label class="flex items-center justify-between gap-3">
                <span class="text-gray-700">ê¸°íƒ€ ì†Œë“ê³µì œ (ì›, ì‹ ìš©ì¹´ë“œ ë“±)</span>
                <input id="otherDeductions" type="text" class="num w-40 rounded-xl border border-emerald-300 px-3 py-2 cute-focus" placeholder="0" value="0" />
              </label>
            </div>
          </div>

          <!-- ì•¡ì…˜ ë²„íŠ¼ -->
          <div class="mt-4 flex flex-wrap items-center gap-2 justify-between">
            <button id="resetBtn" class="mint-btn mint-btn-ghost text-xs md:text-sm whitespace-nowrap">ğŸ”„ ì…ë ¥ ì´ˆê¸°í™”</button>
            <div class="flex items-center gap-2 flex-nowrap">
              <button id="copyUrlBtn" class="mint-btn mint-btn-ghost text-xs md:text-sm whitespace-nowrap">ğŸ”— í˜„ì¬ ì…ë ¥ ê³µìœ  ë§í¬ ë³µì‚¬</button>
              <button id="downloadBtn" class="mint-btn mint-btn-ghost text-xs md:text-sm whitespace-nowrap">ğŸ“¥ ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ê²°ê³¼ -->
      <div class="space-y-6">
        <div id="secB" class="mint-card p-5">
          <h3 class="mb-2 font-semibold sec-title">ì¸ì¶œ ì‹œ ê·¼ë¡œì†Œë“ í•©ì‚° ê¸ˆì•¡ (ë¡œíŠ¸ í•©ê³„) ğŸ’°</h3>
          <div id="withdrawBox" class="text-sm text-gray-800"></div>
        </div>

        <div id="secC" class="mint-card p-5">
          <h3 class="mb-2 font-semibold sec-title">ì„¸ìœ¨ êµ¬ê°„ & ì¶”ê°€ì„¸ê¸ˆ ì‹œë®¬ë ˆì´ì…˜(ê·¼ì‚¬) ğŸ“ˆ</h3>
          <div id="taxbox" class="text-sm text-gray-800"></div>
        </div>

        <div id="detail" class="mint-card p-5 text-sm leading-6 text-emerald-800"></div>
      </div>
    </section>

    <!-- Notes -->
    <section id="how" class="mt-2 mint-card p-5">
      <h3 class="mb-2 text-base font-semibold sec-title">ğŸ“˜ ê³„ì‚° ë¡œì§(ìš”ì§€) & ì£¼ì˜ì‚¬í•­</h3>
      <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
        <li>ê° ë¡œíŠ¸ì˜ ì¸ì¶œ ê³¼ì„¸ë‹¨ê°€ = <strong>min(í•´ë‹¹ ë¡œíŠ¸ì˜ ì·¨ë“ë‹¨ê°€, ì¸ì¶œì¼ì ì‹œê°€)</strong></li>
        <li>ë¹„ê³¼ì„¸ìœ¨(ì˜ë¬´ì˜ˆíƒ ì¢…ë£Œ í›„ ë³´ìœ ê¸°ê°„ ê¸°ì¤€): <strong>2~4ë…„ ë¯¸ë§Œ 50%</strong>, <strong>4ë…„ ì´ìƒ 75%</strong>, <strong>6ë…„ ì´ìƒ 100%</strong>(<strong>ì¤‘ì†Œê¸°ì—…ë§Œ</strong>)</li>
        <li>ì„¸ìœ¨ ì‹œë®¬ë ˆì´ì…˜ì€ ê³µì œ/ë³´í—˜ ë°˜ì˜ <strong>ê³¼ì„¸í‘œì¤€ ê·¼ì‚¬ì¹˜</strong>ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.</li>
      </ul>
      <p class="mt-3 text-xs text-emerald-700">â€» ì‹¤ì œ ì‹ ê³ ëŠ” ê³µì œí•­ëª©Â·ì„¸ì•¡ê³µì œÂ·ê¸‰ì—¬ ì™¸ ì†Œë“ í•©ì‚° ë“±ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆì–´ìš”. ë³¸ ê³„ì‚°ê¸°ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤.</p>
    </section>
  </main>

  <footer class="mt-10 border-t border-emerald-200">
    <div class="mx-auto max-w-6xl px-5 py-6 text-xs text-emerald-700">Â© 2025 ìš°ë¦¬ì‚¬ì£¼ ê°„ì´ ê³„ì‚°ê¸° (ë©€í‹°-ë¡œíŠ¸). ëª¨ë“  ì±…ì„ì€ ì‚¬ìš©ìì—ê²Œ ìˆìœ¼ë©°, ë³¸ ë„êµ¬ëŠ” ì°¸ê³ ìš©ì…ë‹ˆë‹¤.</div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);
    const toNumber = (str) => {
      const cleaned = String(str||'').replace(/[^0-9.-]/g,'');
      const n = parseFloat(cleaned);
      return Number.isFinite(n) ? n : 0;
    };
    const fmt = (n) => Number.isFinite(n) ? n.toLocaleString('ko-KR') : '';

    // ====== Lots state (in-memory) ======
    let lots = []; // {id, acqDate, unit, shares}

    function addLot(acqDate='', unit=0, shares=0){
      const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
      lots.push({id, acqDate, unit, shares});
      renderLots();
      render();
    }
    function removeLot(id){
      lots = lots.filter(l => l.id !== id);
      renderLots();
      render();
    }
    function clearLots(){
      lots = [];
      renderLots();
      render();
    }

    function bindLotRowEvents(rowEl, lot){
      const d = rowEl.querySelector('.lot-date');
      const u = rowEl.querySelector('.lot-unit');
      const s = rowEl.querySelector('.lot-shares');
      const del = rowEl.querySelector('.lot-del');

      d.addEventListener('input', () => { lot.acqDate = d.value; render(); });
      u.addEventListener('input', () => { lot.unit = toNumber(u.value); u.value = fmt(lot.unit); render(); });
      s.addEventListener('input', () => { lot.shares = Math.max(0, Math.floor(toNumber(s.value))); s.value = fmt(lot.shares); render(); });
      del.addEventListener('click', () => removeLot(lot.id));
    }

    function renderLots(){
      const tbody = $('lotBody');
      tbody.innerHTML = '';
      lots.forEach((lot, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-2 py-2 text-xs text-gray-500">${idx+1}</td>
          <td class="px-2 py-2"><input type="date" class="lot-date rounded-xl border border-emerald-300 px-3 py-1.5 cute-focus" value="${lot.acqDate||''}"></td>
          <td class="px-2 py-2 text-right"><input type="text" class="num lot-unit w-32 rounded-xl border border-emerald-300 px-3 py-1.5 cute-focus" value="${fmt(lot.unit||0)}"></td>
          <td class="px-2 py-2 text-right"><input type="text" class="num lot-shares w-28 rounded-xl border border-emerald-300 px-3 py-1.5 cute-focus" value="${fmt(lot.shares||0)}"></td>
          <td class="px-2 py-2 text-right text-xs text-gray-600 lot-hold">-</td>
          <td class="px-2 py-2 text-right text-xs text-gray-600 lot-exempt">-</td>
          <td class="px-2 py-2 text-right text-xs text-gray-600 lot-taxunit">-</td>
          <td class="px-2 py-2 text-right text-xs text-gray-600 lot-taxamt">-</td>
          <td class="px-2 py-2 text-center"><button class="icon-btn lot-del">ì‚­ì œ</button></td>
        `;
        tbody.appendChild(tr);
        bindLotRowEvents(tr, lot);
      });
    }

    // ====== Common helpers ======
    const allFieldIds = [
      'prevYearSalary','currYearSalary','otherIncome',
      'fmvAtWithdraw','basicDeductCount',
      'rateNP','rateHI','rateLTC','rateEI','otherDeductions','escrowYears','esopDeduct'
    ];

    function bindMasks(){
      for (const id of allFieldIds){
        const el = $(id);
        if(!el) continue;
        const handler = () => { el.value = fmt(toNumber(el.value)); render(); };
        el.addEventListener('input', handler);
        el.value = fmt(toNumber(el.value));
      }
      ['wdDate'].forEach(id=>{
        const el = $(id);
        if(el){ el.addEventListener('input', render); el.addEventListener('change', render); }
      });
    }

    function read(){
      const v = {};
      for (const id of allFieldIds) v[id] = toNumber($(id)?.value || 0);
      v.basicDeductCount = Math.max(0, Math.floor(v.basicDeductCount));
      v.isSME = !!$('isSME')?.checked;
      v.wdDate  = $('wdDate')?.value  || '';
      return v;
    }

    function yearsBetween(aStr, bStr){
      if(!aStr || !bStr) return 0;
      const a = new Date(aStr);
      const b = new Date(bStr);
      if (isNaN(a) || isNaN(b)) return 0;
      const ms = b - a;
      return Math.max(0, ms / (1000*60*60*24*365.25));
    }

    function earnedIncomeDeduction(gross){
      const x = Math.max(0, gross);
      if (x <= 12000000) return x*0.7;
      if (x <= 46000000) return 3600000 + (x-12000000)*0.4;
      if (x <= 88000000) return 7500000 + (x-46000000)*0.15;
      if (x <= 150000000) return 13500000 + (x-88000000)*0.05;
      return 16000000 + (x-150000000)*0.02;
    }

    function socialInsurance(prevGross, rateNP, rateHI, rateLTC, rateEI){
      const np = prevGross * (rateNP/100);
      const hi = prevGross * (rateHI/100);
      const ltc = hi * (rateLTC/100);
      const ei = prevGross * (rateEI/100);
      return { np, hi, ltc, ei, total: np+hi+ltc+ei };
    }

    // ====== Core render ======
    function render(){
      const v = read();

      // Per-lot calculations
      let totalShares = 0;
      let totalGross = 0;
      let totalExempt = 0;
      let totalTaxable = 0;

      lots.forEach((lot, idx) => {
        const holdYears = yearsBetween(lot.acqDate, $('wdDate').value);
        const afterEscrow = Math.max(0, holdYears - (v.escrowYears || 0));
        let exemptRate = 0;
        if (afterEscrow >= 6 && v.isSME) exemptRate = 1.0;
        else if (afterEscrow >= 4)      exemptRate = 0.75;
        else if (afterEscrow >= 2)      exemptRate = 0.50;

        const taxUnit = Math.min(lot.unit||0, v.fmvAtWithdraw||0);
        const gross = (lot.shares||0) * taxUnit;
        const exemptAmt = Math.round(gross * exemptRate);
        const taxable = Math.max(0, gross - exemptAmt);

        totalShares += (lot.shares||0);
        totalGross  += gross;
        totalExempt += exemptAmt;
        totalTaxable+= taxable;

        // update UI cells
        const body = $('lotBody');
        const row = body.children[idx];
        if (row){
          row.querySelector('.lot-hold').textContent    = `${afterEscrow.toFixed(2)}ë…„`;
          row.querySelector('.lot-exempt').textContent  = `${Math.round(exemptRate*100)}%`;
          row.querySelector('.lot-taxunit').textContent = `${(taxUnit).toLocaleString('ko-KR')} ì›/ì£¼`;
          row.querySelector('.lot-taxamt').textContent  = `${(taxable).toLocaleString('ko-KR')} ì›`;
        }
      });

      // B ë°•ìŠ¤
      $('withdrawBox').innerHTML = `
        <div class="grid grid-cols-1 gap-3">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="rounded-xl bg-emerald-50 border border-emerald-200 p-3">
              <div class="text-xs text-emerald-700">ì¸ì¶œ ì´ ì£¼ì‹ìˆ˜</div>
              <div class="text-lg font-semibold text-emerald-900">${(totalShares).toLocaleString('ko-KR')} <span class="text-sm">ì£¼</span></div>
            </div>
            <div class="rounded-xl bg-emerald-50 border border-emerald-200 p-3">
              <div class="text-xs text-emerald-700">ì¸ì¶œ ì‹œê°€(ê³µí†µ)</div>
              <div class="text-lg font-semibold text-emerald-900">${(v.fmvAtWithdraw||0).toLocaleString('ko-KR')} <span class="text-sm">ì›/ì£¼</span></div>
            </div>
            <div class="rounded-xl bg-emerald-50 border border-emerald-200 p-3">
              <div class="text-xs text-emerald-700">ì˜ë¬´ì˜ˆíƒê¸°ê°„(ê³µí†µ)</div>
              <div class="text-lg font-semibold text-emerald-900">${(v.escrowYears||0)} <span class="text-sm">ë…„</span></div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="rounded-xl bg-emerald-50 border border-emerald-200 p-3">
              <div class="text-xs text-emerald-700">í•©ì‚° ê¸ˆì•¡(ë¹„ê³¼ì„¸ ì ìš© ì „)</div>
              <div class="text-lg font-semibold text-emerald-900">${(totalGross).toLocaleString('ko-KR')} <span class="text-sm">ì›</span></div>
            </div>
            <div class="rounded-xl bg-emerald-50 border border-emerald-200 p-3">
              <div class="text-xs text-emerald-700">ë¹„ê³¼ì„¸ í•©ê³„</div>
              <div class="text-lg font-semibold text-emerald-900">${(totalExempt).toLocaleString('ko-KR')} <span class="text-sm">ì›</span></div>
            </div>
            <div class="rounded-xl bg-emerald-50 border border-emerald-200 p-3">
              <div class="text-xs text-emerald-700">ê·¼ë¡œì†Œë“ í•©ì‚° ê¸ˆì•¡(ë¹„ê³¼ì„¸ ì ìš© í›„)</div>
              <div class="text-lg font-semibold text-emerald-900">${(totalTaxable).toLocaleString('ko-KR')} <span class="text-sm">ì›</span></div>
            </div>
          </div>
        </div>`;

      // ì„¸ìœ¨/ì¶”ê°€ì„¸ê¸ˆ
      const eidSalaryOnly = earnedIncomeDeduction(v.currYearSalary);
      const si = socialInsurance(v.prevYearSalary, v.rateNP, v.rateHI, v.rateLTC, v.rateEI);
      const basicDeduction = v.basicDeductCount * 1500000;
      const earnedBaseSalaryOnly = Math.max(0, v.currYearSalary - eidSalaryOnly - si.total);
      const approxTaxableIncome = Math.max(0, earnedBaseSalaryOnly + v.otherIncome - basicDeduction - v.esopDeduct - v.otherDeductions + totalTaxable);

      const brackets = [
        { upTo: 14000000,  rate: 0.06 },
        { upTo: 50000000,  rate: 0.15 },
        { upTo: 88000000,  rate: 0.24 },
        { upTo: 150000000, rate: 0.35 },
        { upTo: 300000000, rate: 0.38 },
        { upTo: 500000000, rate: 0.40 },
        { upTo: 1000000000,rate: 0.42 },
        { upTo: Infinity,  rate: 0.45 },
      ];
      const marginalRate = (() => { for (const b of brackets){ if (approxTaxableIncome <= b.upTo) return b.rate; } return 0.45; })();
      const marginalRateWithLocal = marginalRate * 1.10;
      const estimatedAdditionalTaxWithdraw = Math.round(totalTaxable * marginalRateWithLocal);

      const taxRows = brackets.map((b, i) => {
        const from = i === 0 ? 0 : brackets[i-1].upTo + 1;
        const to   = b.upTo === Infinity ? 'ì´ìƒ' : `${fmt(b.upTo)}ì›`;
        const isMy = (approxTaxableIncome <= b.upTo);
        return `<tr class="${isMy ? 'bg-emerald-50' : ''}">
          <td class="px-3 py-1 text-right whitespace-nowrap">${fmt(from)}ì› ~ ${to}</td>
          <td class="px-3 py-1 text-right">${Math.round(b.rate*100)}%</td>
          <td class="px-3 py-1 text-right">${Math.round(b.rate*11000)/100}% (ì§€ë°©ì„¸ í¬í•¨)</td>
        </tr>`;
      }).join('');

      $('taxbox').innerHTML = `
        <div class="grid grid-cols-1 gap-4">
          <div class="rounded-xl bg-emerald-50 border border-emerald-200 p-3 text-sm">
            <div class="grid grid-cols-2 gap-2">
              <div>ì˜¬í•´ ì˜ˆìƒ ì´ê¸‰ì—¬</div><div class="text-right font-semibold">${fmt(v.currYearSalary)} ì›</div>
              <div>ê·¼ë¡œì†Œë“ ì™¸ ì¢…í•©ì†Œë“ê¸ˆì•¡</div><div class="text-right font-semibold">${fmt(v.otherIncome)} ì›</div>
              <div>ê·¼ë¡œì†Œë“ê³µì œ(ê·¼ì‚¬)</div><div class="text-right font-semibold">${fmt(eidSalaryOnly)} ì›</div>
              <div>4ëŒ€ë³´í—˜(ê·¼ë¡œìë¶€ë‹´Â·ê·¼ì‚¬, ì „ê¸° ê¸°ì¤€)</div><div class="text-right font-semibold">${fmt(si.total)} ì› <span class="text-xs text-emerald-700">(êµ­ë¯¼:${fmt(si.np)}, ê±´ë³´:${fmt(si.hi)}, ì¥ê¸°ìš”ì–‘:${fmt(si.ltc)}, ê³ ìš©:${fmt(si.ei)})</span></div>
              <div>ê¸°ë³¸ê³µì œ(ë³¸ì¸ ë“±)</div><div class="text-right font-semibold">${fmt(basicDeduction)} ì›</div>
              <div>ìš°ë¦¬ì‚¬ì£¼ ì¶œì—° ì†Œë“ê³µì œ(ì‚¬ìš©ì ì…ë ¥)</div><div class="text-right font-semibold">${fmt(v.esopDeduct)} ì›</div>
              <div>ê¸°íƒ€ ì†Œë“ê³µì œ</div><div class="text-right font-semibold">${fmt(v.otherDeductions || 0)} ì›</div>
              <div>+ ì¸ì¶œë¶„ ê·¼ë¡œì†Œë“(ë¹„ê³¼ì„¸ ì ìš© í›„)</div><div class="text-right font-semibold">${fmt(totalTaxable)} ì›</div>
              <div>ê³¼ì„¸í‘œì¤€(ê·¼ì‚¬)</div><div class="text-right font-semibold">${fmt(approxTaxableIncome)} ì›</div>
            </div>
          </div>

          <div class="overflow-auto">
            <table class="w-full text-xs">
              <thead class="text-emerald-700">
                <tr>
                  <th class="px-3 py-1 text-right font-medium">ê³¼ì„¸í‘œì¤€ êµ¬ê°„(ê·¼ì‚¬)</th>
                  <th class="px-3 py-1 text-right font-medium">êµ­ì„¸ ì„¸ìœ¨</th>
                  <th class="px-3 py-1 text-right font-medium">í•©ì‚° ì„¸ìœ¨(êµ­ì„¸+ì§€ë°©ì„¸)</th>
                </tr>
              </thead>
              <tbody>${taxRows}</tbody>
            </table>
          </div>

          <div id="additionalTaxCard" class="rounded-xl bg-rose-100 border border-rose-300 p-4 mt-2 shadow-sm text-center">
            <div class="text-xs text-rose-900 mb-1">ì˜ˆìƒ ì¶”ê°€ì„¸ê¸ˆ(ê·¼ì‚¬)</div>
            <div class="text-xl font-extrabold text-rose-900">${fmt(estimatedAdditionalTaxWithdraw)} ì›</div>
          </div>
          <div class="text-xs text-emerald-700">â€» ì¶”ê°€ì„¸ê¸ˆì€ <strong>ì¸ì¶œ ì‹œ ê·¼ë¡œì†Œë“ í•©ì‚° ê¸ˆì•¡(ë¹„ê³¼ì„¸ ì ìš© í›„)</strong> í•©ê³„ì— ì¶”ì • í•œê³„ì„¸ìœ¨(ì§€ë°©ì„¸ í¬í•¨)ì„ ì ìš©í•œ ê°’(ê·¼ì‚¬)ì…ë‹ˆë‹¤.</div>
        </div>`;

      $('detail').innerHTML = `<div class="text-xs text-emerald-700">â€» ë³¸ ê³„ì‚°ê¸°ëŠ” ì°¸ê³ ìš©ì´ë©°, ì‹¤ì œ ì‹ ê³ ëŠ” íšŒì‚¬ ê·œì • ë° ì„¸ë¬´ì „ë¬¸ê°€ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>`;
    }

    function bindActions(){
      $('toggleSI').addEventListener('click', () => {
        ['rateNP','rateHI','rateLTC','rateEI'].forEach(id => { const el = $(id); el.disabled = !el.disabled; });
      });

      $('addRow').addEventListener('click', () => addLot());
      $('clearRows').addEventListener('click', () => clearLots());

      $('resetBtn').addEventListener('click', () => {
        const defaults = {
          prevYearSalary:'0', currYearSalary:'0', otherIncome:'0',
          fmvAtWithdraw:'0', basicDeductCount:'1', rateNP:'4.5', rateHI:'3.545', rateLTC:'12.95', rateEI:'0.9',
          otherDeductions:'0', escrowYears:'1', esopDeduct:'0'
        };
        for (const id of Object.keys(defaults)) $(id).value = defaults[id];
        $('isSME').checked = false;
        $('wdDate').value  = '';
        clearLots();
        addLot(); // at least one row to start
        bindMasks();
        render();
      });

      $('copyUrlBtn').addEventListener('click', () => {
        const params = new URLSearchParams();
        for (const id of allFieldIds) params.set(id, toNumber($(id).value));
        params.set('isSME', $('isSME').checked ? '1':'0');
        params.set('wdDate', $('wdDate').value||'');
        // include lots as JSON
        params.set('lots', encodeURIComponent(JSON.stringify(lots)));
        const url = `${location.origin}${location.pathname}?${params.toString()}`;
        navigator.clipboard.writeText(url).then(() => alert('í˜„ì¬ ì…ë ¥ì´ í¬í•¨ëœ ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”! ğŸ˜Š'));
      });

      $('downloadBtn').addEventListener('click', () => {
        const qs = (id) => document.getElementById(id);
        const rows = [
          ['í•­ëª©','ê°’'],
          ['ì˜¬í•´ ì˜ˆìƒ ì´ê¸‰ì—¬ì•¡', qs('currYearSalary').value],
          ['ê·¼ë¡œì†Œë“ ì™¸ ì¢…í•©ì†Œë“ê¸ˆì•¡', qs('otherIncome').value],
          ['ì¤‘ì†Œê¸°ì—… ì—¬ë¶€', $('isSME').checked ? 'Y':'N'],
          ['ì˜ë¬´ì˜ˆíƒê¸°ê°„(ë…„)', qs('escrowYears').value],
          ['ì¸ì¶œì¼ì', $('wdDate').value],
          ['ì¸ì¶œì¼ì ì‹œê°€', qs('fmvAtWithdraw').value],
          ['ìš°ë¦¬ì‚¬ì£¼ ì¶œì—° ì†Œë“ê³µì œ(ì…ë ¥ê°’)', qs('esopDeduct').value],
          ['ê¸°íƒ€ ì†Œë“ê³µì œ', qs('otherDeductions').value],
          [],
          ['[ë¡œíŠ¸ ìƒì„¸] #','ì·¨ë“ì¼ì','ì·¨ë“ë‹¨ê°€','ì¸ì¶œì£¼ì‹ìˆ˜']
        ];
        lots.forEach((l, i) => {
          rows.push([String(i+1), l.acqDate||'', String(l.unit||0), String(l.shares||0)]);
        });
        const csv = rows.map(r => r.join(',')).join('\\n');
        const blob = new Blob(["\\ufeff" + csv], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'withdraw_multi_lot_result.csv';
        a.click();
      });

      // URL íŒŒë¼ë¯¸í„° ì´ˆê¸°ê°’ ì„¸íŒ…
      const qs = new URLSearchParams(location.search);
      for (const id of allFieldIds){ if(qs.has(id)) $(id).value = fmt(toNumber(qs.get(id))); }
      if (qs.has('isSME')) $('isSME').checked = (qs.get('isSME') === '1');
      if (qs.has('wdDate'))  $('wdDate').value  = qs.get('wdDate');

      if (qs.has('lots')){
        try {
          const arr = JSON.parse(decodeURIComponent(qs.get('lots')));
          if (Array.isArray(arr)) {
            lots = [];
            arr.forEach(o => addLot(o.acqDate||'', toNumber(o.unit), Math.floor(toNumber(o.shares))));
          }
        } catch(e){ addLot(); }
      } else {
        addLot();
      }
    }

    function init(){
      bindMasks();
      bindActions();
      render();
    }
    init();
  </script>
</body>
</html>
